<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sign in — Market Insights</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body { background: #0b0e14; color: #e5e7eb; }
      .glass { background: rgba(23,27,41,.6); border: 1px solid rgba(255,255,255,.08); backdrop-filter: blur(8px); border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    </style>
  </head>
  <body class="d-flex align-items-center" style="min-height:100vh;">
    <main class="container">
      <div class="row justify-content-center">
        <div class="col-12 col-sm-10 col-md-6 col-lg-4">
          <div class="glass p-4">
            <h1 class="h4 text-center mb-3">Market Insights</h1>
            <p class="text-muted small text-center mb-4">Sign in with your email to continue</p>
            <form id="form-start" class="mb-3">
              <div class="mb-3">
                <label class="form-label" for="email">Email</label>
                <input class="form-control" id="email" type="email" placeholder="you@example.com" required />
              </div>
              <button class="btn btn-primary w-100" type="submit" id="btn-send">Send code</button>
            </form>
            <form id="form-verify" class="d-none">
              <div class="mb-3">
                <label class="form-label" for="code">Enter 6-digit code</label>
                <input class="form-control" id="code" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="123456" required />
              </div>
              <button class="btn btn-success w-100" type="submit" id="btn-verify">Verify & Continue</button>
            </form>
            <div id="status" class="small text-muted mt-3"></div>
          </div>
        </div>
      </div>
    </main>

    <script>
    (function(){
      const $ = (s)=> document.querySelector(s);
      const start = $('#form-start');
      const verify = $('#form-verify');
      const status = $('#status');
      let currentEmail = '';
      start.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const email = $('#email').value.trim();
        if(!email){ return; }
        status.textContent = 'Sending code…';
        const res = await fetch('/auth/request_code', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email }) });
        if(!res.ok){ status.textContent = 'Failed to send code. Try again.'; return; }
        const data = await res.json().catch(()=>({}));
        currentEmail = email;
        status.textContent = 'Code sent. Check your email.' + (data.dev_code?` (dev: ${data.dev_code})`: '');
        start.classList.add('d-none'); verify.classList.remove('d-none');
      });
      verify.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const code = $('#code').value.trim();
        status.textContent = 'Verifying…';
        const res = await fetch('/auth/verify_code', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email: currentEmail, code }) });
        if(res.ok){ status.textContent = 'Success. Redirecting…'; } else { status.textContent = 'Invalid or expired code.'; }
      });
    })();
    </script>
  </body>
  </html>
